{% extends 'base.html' %}

{% block title %}
{% if category %}{{ category|title }} - {% endif %}PC Parts - PC Hardware Pro
{% endblock %}

{% block head %}
<style>
    /* Match homepage hover effect */
    .product-card:hover {
        transform: translateY(-10px);
        transition: transform .3s ease;
    }
    .product-card {
        transition: transform .3s ease;
    }
    /* Hero background - uses theme colors */
    .category-hero {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-blend-mode: multiply;
        background-color: var(--bs-carousel-bg); /* Uses theme's carousel overlay color */
    }
    
    /* Make hero text use theme colors */
    .category-hero h1 {
        color: var(--bs-caption-text) !important; /* Uses theme's caption text color */
    }
    
    .category-hero .lead {
        color: var(--bs-caption-text);
        opacity: 0.9;
    }
    /* Theme-aware badge */
    .badge-theme {
        background-color: var(--bs-primary) !important;
        color: #ffffff !important;
    }
    /* Remove underline for anchor links */
    a {
        text-decoration: none;
    }
</style>
{% endblock %}

{% block body %}

<!--   HERO / CATEGORY HEADER  -->
<div class="px-4 py-5 text-center category-hero border-bottom"
     style="background-image: url('https://images.unsplash.com/photo-1604754742629-3e5728249d73?auto=format&w=1600&q=60');">
    <h1 class="display-4 fw-bold">
        {% if search_term %}
            Search Results for "{{ search_term }}"
        {% elif category %}
            {{ category_name|upper if category_name else category|replace('-', ' ')|upper }}
        {% else %}
            ALL PC PARTS
        {% endif %}
    </h1>

    <div class="col-lg-6 mx-auto">
        <p class="lead">

        {% if search_term %}
            Found {{ products|length }} products matching "{{ search_term }}"
        {% elif category == 'cpus' %}
            High-performance processors for gaming and productivity
        {% elif category == 'gpus' %}
            Powerful graphics cards for gaming and creative work
        {% elif category == 'motherboards' %}
            Foundation components for your PC build
        {% elif category == 'memory' %}
            High-speed RAM for optimal system performance
        {% elif category == 'storage' %}
            Fast SSDs and reliable storage solutions
        {% elif category == 'power-supplies' %}
            Reliable power delivery for your system
        {% elif category == 'cooling' %}
            Efficient cooling solutions for optimal performance
        {% elif category == 'cases' %}
            Stylish cases with excellent airflow
        {% elif category == 'accessories' %}
            Essential peripherals and accessories
        {% else %}
            Complete selection of PC components and accessories
        {% endif %}

        </p>

        {% if search_term %}
        <a href="{{ url_for('parts') }}" class="btn btn-outline-light mt-3">
            <i class="bi bi-arrow-left me-2"></i>View All Products
        </a>
        {% else %}
        <span class="badge badge-theme" id="header_count">
            {{ products|length }} products found
        </span>
        {% endif %}
    </div>
</div>

<!--CONTENT -->
<div class="container my-5">
    <!-- Flash messages -->
    {% for message in get_flashed_messages() %}
    <div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    
    <div class="row g-4">

        <!--        FILTER SIDEBAR     -->
        <div class="col-lg-3">
            <div class="card shadow-sm sticky-top" style="top: 2rem;">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-funnel me-2"></i>Filters
                    </h5>

                    <!-- Active Filters -->
                    {% if brand_filter or min_price > 0 or (max_price is not none and max_price < 2000) %}
                        <h6 class="text-muted mb-2">Active Filters:</h6>
                        <div class="d-flex flex-wrap gap-2 mb-4">

                            {% if search_term %}
                            <span class="badge rounded-pill text-bg-primary d-inline-flex align-items-center">
                                Search: "{{ search_term }}"
                                <i class="bi bi-x ms-2" style="cursor:pointer;" onclick="removeFilter('search')"></i>
                            </span>
                            {% endif %}

                            {% if brand_filter %}
                            <span class="badge rounded-pill text-bg-primary d-inline-flex align-items-center">
                                Brand: {{ brand_filter }}
                                <i class="bi bi-x ms-2" style="cursor:pointer;" onclick="removeFilter('brand')"></i>
                            </span>
                            {% endif %}

                            {% if min_price > 0 %}
                            <span class="badge rounded-pill text-bg-primary d-inline-flex align-items-center">
                                Min: ${{ min_price }}
                                <i class="bi bi-x ms-2" style="cursor:pointer;" onclick="removeFilter('min_price')"></i>
                            </span>
                            {% endif %}

                            {% if max_price is not none and max_price < 2000 %}
                            <span class="badge rounded-pill text-bg-primary d-inline-flex align-items-center">
                                Max: ${{ max_price }}
                                <i class="bi bi-x ms-2" style="cursor:pointer;" onclick="removeFilter('max_price')"></i>
                            </span>
                            {% endif %}

                            <span class="badge rounded-pill text-bg-danger d-inline-flex align-items-center"
                                  style="cursor:pointer;" onclick="clearAllFilters()">
                                Clear All <i class="bi bi-x ms-2"></i>
                            </span>
                        </div>
                    {% endif %}
                    <!-- Search Filter -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Search</h6>
                        <div class="input-group input-group-sm">
                            <input type="text"
                                class="form-control"
                                placeholder="Search products..."
                                id="searchInput"
                                value="{{ search_term }}"
                                onkeypress="if(event.keyCode==13) search_within_page()">
                        </div>
                    </div>
                    <hr>
                    <!-- Brand Filter -->
                    {% if brands %}
                    <h6 class="text-muted mb-3">Brand</h6>
                    {% for brand in brands %}
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="brand" value="{{ brand }}"
                               {% if brand_filter == brand %}checked{% endif %}
                               onchange="updateFilters()">
                        <label class="form-check-label">{{ brand }}</label>
                    </div>
                    {% endfor %}
                    <hr>
                    {% endif %}

                    <!-- Price Filter -->
                    <h6 class="text-muted mb-3">Price Range</h6>
                    
                    <!-- Display current range -->
                    <div class="text-center mb-2">
                        <span class="badge text-bg-secondary">
                            $<span id="minDisplay">{{ min_price }}</span> - $<span id="maxDisplay">{{ max_price if max_price is not none else 2000 }}</span>
                        </span>
                    </div>
                    
                    <!-- Separate sliders with labels -->
                    <div class="mb-3">
                        <label class="form-label small">Minimum: $<span id="minLabel">{{ min_price }}</span></label>
                        <input type="range" class="form-range"
                               id="minSlider"
                               min="0" max="2000" step="10"
                               value="{{ min_price }}"
                               oninput="updateMinSlider(this.value)">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small">Maximum: $<span id="maxLabel">{{ max_price if max_price is not none else 2000 }}</span></label>
                        <input type="range" class="form-range"
                               id="maxSlider"
                               min="0" max="2000" step="10"
                               value="{{ max_price if max_price is not none else 2000 }}"
                               oninput="updateMaxSlider(this.value)">
                    </div>
                    
                    <!-- Number inputs for precise control -->
                    <div class="d-flex gap-2 mt-2">
                        <input type="number" id="minPrice"
                               class="form-control form-control-sm"
                               placeholder="Min" 
                               value="{{ min_price }}"
                               min="0" max="2000"
                               onchange="syncSliders()">
                        <input type="number" id="maxPrice"
                               class="form-control form-control-sm"
                               placeholder="Max"
                               value="{{ max_price if max_price is not none else 2000 }}"
                               min="0" max="2000"
                               onchange="syncSliders()">
                    </div>
                    
                    <button class="btn btn-sm btn-primary w-100 mt-2" onclick="updateFilters()">
                        Apply Price Filter
                    </button>

                    <hr>

                    <!-- Category Navigation -->
                    <h6 class="text-muted mb-3">Categories</h6>
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('parts') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-grid-3x3-gap me-2"></i>All PC Parts
                        </a>

                        <a href="{{ url_for('parts', category='cpus') }}"
                           class="list-group-item list-group-item-action {% if category == 'cpus' %}active{% endif %}">
                           <i class="bi bi-cpu me-2"></i>Processors
                        </a>

                        <a href="{{ url_for('parts', category='gpus') }}"
                           class="list-group-item list-group-item-action {% if category == 'gpus' %}active{% endif %}">
                           <i class="bi bi-gpu-card me-2"></i>Graphics Cards
                        </a>

                        <a href="{{ url_for('parts', category='motherboards') }}"
                           class="list-group-item list-group-item-action {% if category == 'motherboards' %}active{% endif %}">
                           <i class="bi bi-motherboard me-2"></i>Motherboards
                        </a>

                        <a href="{{ url_for('parts', category='memory') }}"
                           class="list-group-item list-group-item-action {% if category == 'memory' %}active{% endif %}">
                           <i class="bi bi-memory me-2"></i>Memory
                        </a>

                        <a href="{{ url_for('parts', category='storage') }}"
                           class="list-group-item list-group-item-action {% if category == 'storage' %}active{% endif %}">
                           <i class="bi bi-hdd me-2"></i>Storage
                        </a>

                        <a href="{{ url_for('parts', category='power-supplies') }}"
                           class="list-group-item list-group-item-action {% if category == 'power-supplies' %}active{% endif %}">
                           <i class="bi bi-lightning-charge me-2"></i>Power Supplies
                        </a>

                        <a href="{{ url_for('parts', category='cooling') }}"
                           class="list-group-item list-group-item-action {% if category == 'cooling' %}active{% endif %}">
                           <i class="bi bi-fan me-2"></i>Cooling
                        </a>

                        <a href="{{ url_for('parts', category='cases') }}"
                           class="list-group-item list-group-item-action {% if category == 'cases' %}active{% endif %}">
                           <i class="bi bi-pc me-2"></i>Cases
                        </a>

                        <a href="{{ url_for('parts', category='accessories') }}"
                           class="list-group-item list-group-item-action {% if category == 'accessories' %}active{% endif %}">
                           <i class="bi bi-keyboard me-2"></i>Accessories
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!--       PRODUCT GRID        -->
        <div class="col-lg-9">

            <!-- Sort bar -->
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted">Sort by:</span>
                    <select class="form-select form-select-sm" onchange="sortProducts(this.value)">
                        <option value="featured">Featured</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>

                <span class="text-muted" id="product_count">
                    Showing {{ products|length }} products
                </span>
            </div>

            <!-- Product cards -->
            {% if products %}
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
                {% for product in products %}
                
                <div class="col">
                    <div class="card shadow-sm border-0 h-100 product-card">
                        <a href="{{ url_for('product', product_id=product.product_ID)}}">
                        <img src="{{ url_for('static', filename=product.product_Image.replace('static/', '')) if product.product_Image else url_for('static', filename='images/default.png') }}"
                             class="card-img-top"
                             alt="{{ product.product_Name }}"
                             style="height:200px; object-fit:cover;">
                        
                        <div class="card-body">
                            <h5 class="card-title">{{ product.product_Name }}</h5>
                            <p class="card-text text-muted">{{ product.product_Brand }}</p>
                            <p class="card-text fw-bold">${{ "%.2f"|format(product.product_Price) }}</p>
                            <p class="card-text small text-muted">{{ product.product_Description[:100] }}{% if product.product_Description|length > 100 %}...{% endif %}</p>

                            
                            {% if product.product_Stock > 0 %}
                                <p class="card-text small text-success">
                                    <i class="bi bi-check-circle me-1"></i>In Stock
                                </p>
                                <a href="{{ url_for('add_to_cart', product_id=product.product_ID) }}" 
                                   class="btn btn-primary w-100 mt-3">
                                    <i class="bi bi-cart-plus me-2"></i>Add to Cart
                                </a>
                            {% else %}
                                <p class="card-text small text-danger">
                                    <i class="bi bi-x-circle me-1"></i>Out of Stock
                                </p>
                                <button class="btn btn-secondary w-100 mt-3" disabled>
                                    <i class="bi bi-cart-x me-2"></i>Unavailable
                                </button>
                            {% endif %}
                        </div>
                        </a>

                    </div>
                    </div>
                </div>

                {% endfor %}
            </div>

            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h3 class="text-muted mt-3">No products found</h3>
                <a href="{{ url_for('parts', category=category) }}" class="btn btn-primary mt-2">
                    Clear Filters
                </a>
            </div>
            {% endif %}

        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function updateMinSlider(value) {
    const maxSlider = document.getElementById('maxSlider');
    const maxValue = parseInt(maxSlider.value);
    
    // Prevent min from exceeding max
    if (parseInt(value) > maxValue) {
        value = maxValue;
        document.getElementById('minSlider').value = value;
    }
    
    // Update all displays
    document.getElementById('minDisplay').textContent = value;
    document.getElementById('minLabel').textContent = value;
    document.getElementById('minPrice').value = value;
}

function updateMaxSlider(value) {
    const minSlider = document.getElementById('minSlider');
    const minValue = parseInt(minSlider.value);
    
    // Prevent max from going below min
    if (parseInt(value) < minValue) {
        value = minValue;
        document.getElementById('maxSlider').value = value;
    }
    
    // Update all displays
    document.getElementById('maxDisplay').textContent = value;
    document.getElementById('maxLabel').textContent = value;
    document.getElementById('maxPrice').value = value;
}

function syncSliders() {
    const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
    const maxPrice = parseInt(document.getElementById('maxPrice').value) || 2000;
    
    // Update sliders when number inputs change
    document.getElementById('minSlider').value = minPrice;
    document.getElementById('maxSlider').value = maxPrice;
    
    // Update displays
    updateMinSlider(minPrice);
    updateMaxSlider(maxPrice);
}

function updateFilters() {
    const brand = document.querySelector('input[name="brand"]:checked')?.value || '';
    const minPrice = document.getElementById('minPrice').value || 0;
    const maxPrice = document.getElementById('maxPrice').value || 2000;
    const searchTerm = document.getElementById('searchInput').value || '';

    let url = '{{ url_for("parts", category=category) }}';
    const params = new URLSearchParams();

    if (searchTerm) params.append('search', searchTerm);
    if (brand) params.append('brand', brand);
    if (minPrice > 0) params.append('min_price', minPrice);
    if (maxPrice < 2000) params.append('max_price', maxPrice);

    window.location.href = params.toString() ? url + '?' + params.toString() : url;
}

function removeFilter(type) {
    const url = new URL(window.location.href);
    url.searchParams.delete(type);
    window.location.href = url;
}

function clearAllFilters() {
    window.location.href = '{{ url_for("parts", category=category) }}';
}

function sortProducts(value) {
    alert("Sorting would occur server-side: " + value);
}

let searchTimeout = null;

function search_within_page() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    const productCards = document.querySelectorAll('.product-card');
    let visibleCount = 0;

    productCards.forEach(card => {
        const productName = card.querySelector('.card-title').textContent.toLowerCase();
        const productBrand = card.querySelector('.text-muted').textContent.toLowerCase();
        const productDescription = card.querySelector('.small.text-muted').textContent.toLowerCase();
        
        // Check if any field contains the search query
        const matches = productName.includes(query) || 
                       productBrand.includes(query) || 
                       productDescription.includes(query);
        
        if (matches || query === '') {
            card.style.display = '';
            visibleCount++;
            
            // Highlight matching text
            if (query) {
                highlightText(card, query);
            } else {
                removeHighlights(card);
            }
        } else {
            card.style.display = 'none';
            removeHighlights(card);
        }
    });

    // Update product count display
    const countElement1 = document.getElementById('header_count');
    if (countElement1) {
        countElement1.textContent = `${visibleCount} products found`;
    }
    const countElement2 = document.getElementById('product_count');
    if (countElement2) {
        countElement2.textContent = `Showing ${visibleCount} products`;
    }
}

function highlightText(card, query) {
    // Remove existing highlights first
    removeHighlights(card);
    
    // Highlight in product name
    const titleElement = card.querySelector('.card-title');
    titleElement.innerHTML = highlightTextInElement(titleElement.textContent, query);
    
    // Highlight in brand
    const brandElement = card.querySelector('.text-muted');
    brandElement.innerHTML = highlightTextInElement(brandElement.textContent, query);
    
    // Highlight in description
    const descElement = card.querySelector('.small.text-muted');
    descElement.innerHTML = highlightTextInElement(descElement.textContent, query);
}

function highlightTextInElement(text, query) {
    if (!query) return text;
    
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<mark class="bg-warning">$1</mark>');
}

function removeHighlights(card) {
    const elements = card.querySelectorAll('.card-title, .text-muted, .small.text-muted');
    elements.forEach(element => {
        element.innerHTML = element.innerHTML.replace(/<mark class="bg-warning">(.*?)<\/mark>/gi, '$1');
    });
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Initialize search functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    
    // Add event listener for real-time search
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            search_within_page();
        }, 300); // 300ms delay
    });
    
    // Apply any existing search term on page load
    if (searchInput.value) {
        search_within_page();
    }
});

</script>
{% endblock %}