{% extends 'base.html' %}

{% block title %}Account - PC Parts Store{% endblock %}

{% block head %}
{% endblock %}

{% block body %}
<main>
    <h1>Account Management</h1>
    <!-- Flash messages -->
    {% for message in get_flashed_messages() %}
    <div class="alert alert-warning mt-3" role="alert">
        {{ message }}
    </div>
    {% endfor %}
    {% if form.userid.data %}
        <h4>Edit Your Account</h4>
        <form action="{{ url_for('account') }}" method="post" id="accountform">
            {{ form.hidden_tag() }}
            <input type="hidden" name="userid" value="{{ form.userid.data }}">

            <label for="username" class="form-label">Username:</label>
            {{ form.username(class="form-control", id="username") }}

            <label for="email" class="form-label">Email:</label>
            {{ form.email(class="form-control", id="email") }}

            <label for="address" class="form-label">Address:</label>
            {{ form.address(class="form-control", id="address") }}

            <label for="city" class="form-label">City:</label>
            {{ form.city(class="form-control", id="city") }}

            <label for="state" class="form-label">State:</label>
            {{ form.state(class="form-control", id="state") }}

            <label for="zip" class="form-label">Zip Code:</label>
            {{ form.zip(class="form-control", id="zip") }}

            <div class="mb-3 password-container">
                <label for="password" class="form-label">New Password:</label>
                {{ form.password(class="form-control", id="password", type="password", placeholder="Leave blank to keep current password") }}
                <button type="button" class="password-toggle" id="togglePassword">
                    <i class="bi bi-eye-slash"></i>
                </button>
            </div>
            <div class="mb-3 password-container">
                <label for="confirmpassword" class="form-label">Confirm New Password</label>
                <input type="password" class="form-control" id="confirmpassword" name="confirmpassword">
                <button type="button" class="password-toggle" id="toggleConfirmPassword">
                    <i class="bi bi-eye-slash"></i>
                </button>
            </div>
            {{ form.update(class="btn btn-warning") }}
            <a href="{{ url_for('account') }}" class="btn btn-secondary">Cancel</a>
        </form>
        <div class="password-requirements">
            <h5>Password Requirements:</h5>
            <ul class="list-unstyled">
                <li>At least 9 characters</li>
                <li>1 uppercase letter</li>
                <li>1 number</li>
                <li>1 special character</li>
            </ul>
        </div>
    {% endif %}
    <!-- Users Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Role</th>
                    <th scope="col">Username</th>
                    <th scope="col">DOB</th>
                    <th scope="col">Address</th>
                    <th scope="col">City</th>
                    <th scope="col">State</th>
                    <th scope="col">Zipcode</th>
                    <th scope="col">Email</th>
                    <th scope="col">Date Added</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th scope="row">{{ user.user_ID }}</th>
                    <td>
                        <span class="badge {% if user.user_Role == 'root_admin' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ user.user_Role }}
                        </span>
                    </td>
                    <td>{{ user.user_Name }}</td>
                    <td>{{ user.user_DOB.strftime('%Y-%m-%d') if user.user_DOB else 'N/A' }}</td>
                    <td>{{ user.user_Address or 'N/A' }}</td>
                    <td>{{ user.user_City or 'N/A' }}</td>
                    <td>{{ user.user_State or 'N/A' }}</td>
                    <td>{{ user.user_Zip or 'N/A' }}</td>
                    <td>{{ user.user_Email }}</td>
                    <td>{{ user.date_added.strftime('%Y-%m-%d') }}</td>
                    <td class="action-buttons">
                        {% if not form.userid.data %}
                        <a href="{{ url_for('account', edit_account=user.user_ID) }}" 
                             class="btn btn-primary btn-sm">Edit</a>
                        {% endif %}
                        <form action="{{ url_for('account') }}" method="post" class="d-inline">
                            {{ delete_form.hidden_tag() }}
                            <input type="hidden" name="delete_user" value="{{ user.user_ID }}">
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to delete your account, {{ user.user_Name }}? This action cannot be undone.')">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</main>
{% endblock %}
{% block scripts %}
    <!-- Registration Form Script -->
    <script>
        // Password toggle functionality
        const togglePassword = document.querySelector('#togglePassword');
        const password = document.querySelector('#password');
        const eyeIcon = togglePassword.querySelector('i');

        const toggleConfirmPassword = document.querySelector('#toggleConfirmPassword');
        const confirmPassword = document.querySelector('#confirmpassword');
        const confirmEyeIcon = toggleConfirmPassword.querySelector('i');

        // Create password match message element
        const passwordMatchMessage = document.createElement('div');
        passwordMatchMessage.className = 'alert alert-warning mt-2';
        passwordMatchMessage.style.display = 'none';
        // Insert after the confirm password container
        confirmPassword.closest('.password-container').appendChild(passwordMatchMessage);

        togglePassword.addEventListener('click', function () {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            eyeIcon.classList.toggle('bi-eye');
            eyeIcon.classList.toggle('bi-eye-slash');
        });

        toggleConfirmPassword.addEventListener('click', function () {
            const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPassword.setAttribute('type', type);
            confirmEyeIcon.classList.toggle('bi-eye');
            confirmEyeIcon.classList.toggle('bi-eye-slash');
        });

        // Live password matching validation
        function validatePasswordMatch() {
            const passwordValue = password.value;
            const confirmPasswordValue = confirmPassword.value;
            
            if (confirmPasswordValue === '') {
                passwordMatchMessage.style.display = 'none';
                confirmPassword.setCustomValidity('');
                return;
            }
            
            if (passwordValue !== confirmPasswordValue) {
                passwordMatchMessage.textContent = 'Passwords do not match';
                passwordMatchMessage.className = 'alert alert-warning mt-2';
                passwordMatchMessage.style.display = 'block';
                confirmPassword.setCustomValidity('Passwords do not match');
            } else {
                passwordMatchMessage.textContent = 'Passwords match!';
                passwordMatchMessage.className = 'alert alert-success mt-2';
                passwordMatchMessage.style.display = 'block';
                confirmPassword.setCustomValidity('');
            }
        }

        // Add event listeners for live validation
        password.addEventListener('input', validatePasswordMatch);
        confirmPassword.addEventListener('input', validatePasswordMatch);

        // Form submission validation
        document.getElementById('accountform').addEventListener('submit', function(e) {
            const passwordValue = password.value;
            const confirmPasswordValue = confirmPassword.value;
            
            if (passwordValue !== confirmPasswordValue) {
                e.preventDefault();
                passwordMatchMessage.textContent = 'Please fix password mismatch before submitting';
                passwordMatchMessage.className = 'alert alert-danger mt-2';
                passwordMatchMessage.style.display = 'block';
                confirmPassword.focus();
            }
        });
    </script>
{% endblock %}